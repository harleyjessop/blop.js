/*
 *  Blop.js - v2.0.0
 *  Client side dropping and cropping using canvas and delivering a nice clean blob.
 *  
 *
 *  Made by Harley Jessop
 *  Under MIT License
 */
!function(a){function b(b,e){this.elem=b,this.opt=a.extend({},d,e),this._defaults=d,this._name=c,this.init()}var c="blop",d={blk:".blop",elZone:"__dropzone",elPrev:"__preview",elInput:"__input",elSelBtn:"__select",elClrBtn:"__clear",elSetBtn:"__set",elPrevImg:"__image",elResult:"__result",modEmpty:"blop--empty",modActive:"blop--active",modSet:"blop--set",setWidth:250,setHeight:250,jcrop:{aspectRatio:1,minSize:[25,25],maxSize:[0,0],setSelect:[0,0,250,250],bgColor:"white",bgOpacity:.3,api:{}},onClearCallback:function(){},onSetCallback:function(){},currentFile:null,coords:null,cropping:null};b.prototype={init:function(){this.bindUIActions()},bindUIActions:function(){var b=this;a(b.elem).on("dragover",b.opt.blk+b.opt.elZone,function(){return!1}),a(b.elem).on("drop",b.opt.blk+b.opt.elZone,function(a){a.preventDefault(),b.handleDrop(a)}),a(b.elem).on("change",b.opt.blk+b.opt.elInput,function(a){b.handleDrop(a)}),a(b.elem).on("click",b.opt.blk+b.opt.elClrBtn,function(c){c.preventDefault(),a(b.elem).find(b.opt.blk+b.opt.elInput).val(""),b.showDropzone(),a(b.elem).find(b.opt.blk+b.opt.elPrevImg).remove();var d=a(b.elem).find(".jcrop-holder");d.length>0&&(b.opt.jcrop.api.instance.destroy(),d.remove()),b.opt.onClearCallback()}),a(b.elem).on("click",b.opt.blk+b.opt.elSetBtn,function(a){a.preventDefault(),b.setCrop()})},showDropzone:function(){var b=this;a(b.elem).addClass("empty"),a(b.elem).removeClass("set active")},hideDropzone:function(){var b=this;a(b.elem).removeClass("empty")},handleDrop:function(a){var b=this;b.hideDropzone(),a=a.originalEvent;var c=a.dataTransfer||a.target,d=c&&c.files&&c.files[0];d&&(b.opt.currentFile=d,b.displayImg(d))},displayImg:function(b){var c=this;loadImage(b,function(b){c.replaceImg(b,function(){a(c.elem).addClass("active"),c.handleCrop(b)})},{canvas:!0})||a(c.opt.blk+c.opt.result).children().replaceWith(a("<span>Your browser does not support the URL or FileReader API. Please upgrade to a modern browser!</span>"))},replaceImg:function(b,c){var d,e=this;d=b.src||b instanceof HTMLCanvasElement?a(b).addClass("blop__image"):a("<span>Loading image file failed</span>"),a(e.opt.blk+e.opt.elResult).html(d),c(d)},handleCrop:function(b){function c(a){d.opt.coords=a}var d=this;d.opt.jcrop.aspectRatio=d.opt.setWidth/d.opt.setHeight,d.opt.jcrop.setSelect=[0,0,d.opt.setWidth,d.opt.setHeight],a(b).Jcrop({aspectRatio:d.opt.jcrop.aspectRatio,minSize:d.opt.jcrop.minSize,maxSize:d.opt.jcrop.maxSize,setSelect:d.opt.jcrop.setSelect,bgColor:d.opt.jcrop.bgColor,bgOpacity:d.opt.jcrop.bgOpacity,trueSize:[b.width,b.height],boxWidth:a(b).width(),boxHeight:a(b).height(),onSelect:c,onChange:c,onRelease:c(null)},function(){d.opt.jcrop.api.instance=this}).parent().on("click",function(a){a.preventDefault()})},setCrop:function(){var b=this,c=a(b.elem).find(b.opt.blk+b.opt.elResult).find("img, canvas")[0];c&&b.opt.coords&&(b.replaceImg(loadImage.scale(c,{left:b.opt.coords.x,top:b.opt.coords.y,sourceWidth:b.opt.coords.w,sourceHeight:b.opt.coords.h,maxWidth:b.opt.setWidth,maxHeight:b.opt.setHeight,crop:!0}),function(a){b.allDone(a)}),b.opt.coords=null)},allDone:function(b){var c=this;a(c.elem).removeClass("active").addClass("set"),b.toBlob&&b.toBlob(function(a){c.opt.onSetCallback(a)},c.opt.currentFile.type,.6)}},a.fn[c]=function(d){return this.each(function(){a.data(this,"plugin_"+c)||a.data(this,"plugin_"+c,new b(this,d))})}}(jQuery,window,document);